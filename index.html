<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Симулятор трёх тел</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  
  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)']], displayMath: [['\\[','\\]']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  
  <style>
    .mass-icon-circle { display: none !important; }
    .is-circles-mode .mass-icon-image { display: none !important; }
    .is-circles-mode .mass-icon-circle { display: inline-block !important; }
    .mass-circle {
      display: inline-block;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0,0,0,0.35);
      vertical-align: middle;
    }
    .as-circle {
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0,0,0,0.35);
    }
    .is-circles-mode .ThreeBodyProblem-bodyImage { display: none !important; }

    .approximation-display-style {
      background-color: rgba(28, 37, 65, 0.7);
      padding: 15px 20px;
      margin: 10px auto 0 auto;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      max-width: 700px;
      color: #f0f0f0;
    }
    .approximation-display-style h4 {
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 600;
    }
    .approximation-display-style pre {
      font-family: monospace;
      font-size: 1.1em;
      text-align: left;
      margin: 10px auto;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
      white-space: pre-wrap;
    }
    #formula-text-0 { color: #ff8b22; }
    #formula-text-1 { color: #6c81ff; }
    #formula-text-2 { color: #4ccd7a; }
  </style>

</head>
<body>

  <div id="loader-wrapper">
    <div class="loader">
      <div class="inner one"></div>
      <div class="inner two"></div>
      <div class="inner three"></div>
    </div>
    <div class="loader">
      <div class="inner one"></div>
      <div class="inner two"></div>
      <div class="inner three"></div>
    </div>
  </div>

  <h1>Симулятор трёх тел</h1>
  <p id="ThreeBodyProblem-notSupportedMessage" class="ThreeBodyProblem-alert ThreeBodyProblem-isHiddenBlock">
    Пожалуйста, используйте современный браузер для просмотра симуляции.
  </p>

  <div class="ThreeBodyProblem-container isFullScreenWide isUnselectable">
    <div class="ThreeBodyProblem-sun">
      <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/sun.png" class="ThreeBodyProblem-spin ThreeBodyProblem-bodyImage" alt="Солнце" />
    </div>
    <div class="ThreeBodyProblem-earth">
      <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/earth.png" alt="Земля" class="ThreeBodyProblem-spin ThreeBodyProblem-bodyImage"/>
    </div>
    <div class="ThreeBodyProblem-jupiter">
      <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/jupiter_juno.png" alt="Юпитер" class="ThreeBodyProblem-spin ThreeBodyProblem-bodyImage" />
    </div>
    <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/center_of_mass.png" alt="Центр масс" class="ThreeBodyProblem-centerOfMass" />
    <canvas class="ThreeBodyProblem-canvas"></canvas>

    <div class="ThreeBodyProblem-hudContainer">
      <div class="ThreeBodyProblem-hudContainerChild"></div>
      
      <div class="ThreeBodyProblem-leftBottomButtonCantainer">
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-mass1Button ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Масса 1">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/mass_one_icon.png" alt="Масса 1" class="ThreeBodyProblem-leftBottomImage mass-icon-image">
          <span class="mass-circle mass-icon-circle" style="background:#ff8b22"></span>
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-mass2Button ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Масса 2">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/mass_two_icon.png" alt="Масса 2" class="ThreeBodyProblem-leftBottomImage mass-icon-image">
          <span class="mass-circle mass-icon-circle" style="background:#6c81ff"></span>
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-mass3Button ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Масса 3">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/mass_three_icon.png" alt="Масса 3" class="ThreeBodyProblem-leftBottomImage mass-icon-image">
          <span class="mass-circle mass-icon-circle" style="background:#4ccd7a"></span>
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-speedButton ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Скорость">
          <img src="https://evgenii.com/image/blog/2018-09-27-three-body-problem-simulator/clock_icon.png" alt="Скорость" class="ThreeBodyProblem-leftBottomImage">
        </a>
        <a class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-softeningButton ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Смягчение">
          <img src="https://img.icons8.com/?size=1200&id=uPZIaAnibVWL&format=png" alt="Смягчение" class="ThreeBodyProblem-leftBottomImage">
        </a>
        <a id="info-button" class="ThreeBodyProblem-leftBottomButton ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Инструкция">
          <img src="https://www.nvdemarie.be/files/modules/products/53/Infobalie.png" alt="Инструкция" class="ThreeBodyProblem-leftBottomImage">
        </a>
      </div>
      
      <div class="ThreeBodyProblem-rightBottomButtonContainer">
          <button class="ThreeBodyProblem-pause ThreeBodyProblem-button">Пауза</button>
          <a class="ThreeBodyProblem-reload ThreeBodyProblem-doesChangeOpacityOnHover" href="#" title="Перезапуск">
            <img src="https://evgenii.com/image/blog/2016-09-17-ridiculous-strawberry-picking/reload_icon.png" alt="Перезапуск" class="ThreeBodyProblem-reloadIcon">
          </a>
      </div>
    </div>
  </div>
  
  <div class="ThreeBodyProblem-controlsArea">
    <div class="ThreeBodyProblem-isTextCentered ThreeBodyProblem-hasTopMarginSmall ThreeBodyProblem-hasNegativeBottomMarginNormal isUnselectable">
      <span class="ThreeBodyProblem-sliderLabel">0.01</span>
    </div>
    <div class="SickSlider ThreeBodyProblem-slider isUnselectable">
      <div class="SickSlider-stripe"></div>
      <div class="SickSlider-head"></div>
    </div>
    
    <div class="ThreeBodyProblem-isTextCentered" style="margin-top: 20px;">
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button ThreeBodyProblem-button--isSelected" data-name="FigureEight">Восьмёрка</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="SunEarthJupiter">Солнце, Земля и Юпитер</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="LagrangePoint5">Точка Лагранжа L5</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="Kepler16">Кеплер-16</button>
      <button class="ThreeBodyProblem-preset ThreeBodyProblem-button" data-name="Chaotic">Хаотический</button>
      
      <button class="ThreeBodyProblem-button" id="download-scene-button">Скачать сцену</button>
      <button class="ThreeBodyProblem-button" id="upload-scene-button">Загрузить сцену</button>
      <input type="file" id="scene-uploader" accept="application/json, .json" style="display: none;" />

      <button class="ThreeBodyProblem-button" id="check-activity-button" style="display:none; border-color:#7bf0ff; color:#d7fbff;">
        Проверить
      </button>

      <button class="ThreeBodyProblem-button" id="labs-menu-button" style="border-color: #ff8b22; color: #ffcd9c;">Тренажёр</button>
    </div>
  </div>

  <div id="charts-container" style="max-width: 1100px; margin: 20px auto;">
    <details id="vel-details" style="margin-bottom: 10px;">
      <summary style="cursor:pointer; font-weight:600;">График скоростей (раскрыть/свернуть)</summary>
      <div style="width: 100%; height: 360px; margin-top: 10px;">
        <canvas id="velocityChart" style="width:100%; height:100%;"></canvas>
      </div>
    </details>
    <details id="eng-details" style="margin-bottom: 10px;">
      <summary style="cursor:pointer; font-weight:600;">График ускорений (раскрыть/свернуть)</summary>
      <div style="width: 100%; height: 360px; margin-top: 10px;">
        <canvas id="accelerationChart" style="width:100%; height:100%;"></canvas>
      </div>
    </details>
    <details id="approx-details">
      <summary style="cursor:pointer; font-weight:600;">Мгновенные аппроксимации траекторий (раскрыть/свернуть)</summary>
      <div id="approximation-display" class="approximation-display-style">
        <h4>Мгновенные аппроксимации траекторий</h4>
        <div style="text-align: center; margin-bottom: 15px;">
           <button class="ThreeBodyProblem-button" id="download-log-button">Скачать лог формул</button>
        </div>
        <pre id="formula-text-0"></pre>
        <pre id="formula-text-1"></pre>
        <pre id="formula-text-2"></pre>
      </div>
    </details>
  </div>

  <div id="info-modal" class="modal-overlay is-hidden">
    <div class="modal-content">
      <button class="modal-close-button" title="Закрыть">&times;</button>
      <div class="instruction-container">
        <h2>Инструкция по использованию симулятора</h2>
        <p>
          Добро пожаловать в интерактивный симулятор задачи трёх тел! Эта программа позволяет моделировать движение трёх объектов в пространстве под действием их взаимного гравитационного притяжения.
        </p>

        <h3>Как пользоваться</h3>
        <ol>
          <li><strong>Выберите пресет</strong> внизу (песочница) или откройте <strong>«Тренажёр»</strong> (лабы и задания).</li>
          <li><strong>Настройте параметры</strong> (удобнее на паузе).</li>
          <li><strong>Наблюдайте</strong> траектории и анализируйте графики ниже.</li>
        </ol>

        <h3>Элементы управления</h3>
        <ul>
          <li><strong>Кнопки пресетов:</strong> ("Восьмёрка", "Солнце, Земля и Юпитер" и т.д.) — загружают предопределённые начальные условия.</li>
          <li><strong>Пауза / Продолжить:</strong> приостанавливает или возобновляет симуляцию.</li>
          <li><strong>Перезапуск (иконка со стрелкой):</strong> сбрасывает текущий пресет/активность к начальному состоянию.</li>
          <li><strong>Кнопки параметров (слева внизу):</strong>
            <ul>
              <li><strong>Масса 1, 2, 3:</strong> выберите тело и меняйте его массу слайдером.</li>
              <li><strong>Скорость:</strong> скорость течения времени в симуляции.</li>
              <li><strong>Смягчение (ε):</strong> параметр для численной устойчивости при близких сближениях.</li>
            </ul>
          </li>
          <li><strong>Слайдер:</strong> основной инструмент изменения выбранного параметра. Также можно нажать на текст над слайдером (в режиме массы), чтобы ввести число вручную.</li>
          <li><strong>Скачать / Загрузить сцену:</strong> сохранение/загрузка текущих начальных условий (JSON).</li>
        </ul>

        <h3>Тренажёр (лабораторные и задания)</h3>
        <p>
          Кнопка <strong>«Тренажёр»</strong> открывает меню активностей:
        </p>
        <ul>
          <li><strong>Лабораторные работы</strong> — учебные сценарии для исследования явлений (манёвр, двойные системы, побег и т.п.).</li>
          <li><strong>Задания</strong> — сценарии с <strong>автопроверкой</strong>: нужно добиться заданного поведения системы (например, удержать орбиту, выполнить побег, удержать конфигурацию около L4/L5). В конце показывается окно результата, можно скачать отчёт (JSON).</li>
        </ul>
        <p>
          В тренажёре часть параметров может быть <strong>заблокирована</strong> (по условиям задачи). Обычно порядок работы такой:
          прочитать брифинг → перейти к настройке (симуляция на паузе) → запустить «Продолжить».
        </p>

        <h3>Графики и аппроксимации</h3>
        <p>
          Ниже симуляции доступны графики скоростей и ускорений, а также блок мгновенных аппроксимаций траекторий.
          Можно скачать лог формул кнопкой «Скачать лог формул».
        </p>

        <h3>Описание пресетов</h3>
        <ul>
          <li><strong>Восьмёрка:</strong> классическое устойчивое решение задачи трёх тел.</li>
          <li><strong>Солнце, Земля и Юпитер:</strong> упрощённая модель Солнечной системы.</li>
          <li><strong>Точка Лагранжа L5:</strong> демонстрация точек стабильности.</li>
          <li><strong>Кеплер-16:</strong> модель экзопланетной системы с двумя звёздами.</li>
          <li><strong>Хаотический:</strong> демонстрация непредсказуемости системы.</li>
        </ul>

        <h3>Советы</h3>
        <ul>
          <li>Если в заданиях “не засчитывает” — смотрите метрики r и e (и HUD, если включён). Частая причина: орбита слишком вытянута (r выходит за пределы).</li>
          <li>Если тело “проваливается внутрь” — обычно нужно <strong>уменьшить</strong> массу центрального тела или снизить скорость.</li>
          <li>Если тело “улетает наружу” — обычно нужно <strong>увеличить</strong> массу центрального тела или снизить скорость.</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="error-modal" class="modal-overlay is-hidden">
    <div class="modal-content error-modal-content">
      <div class="error-icon">⚠️</div>
      <div class="error-title">Ошибка</div>
      <div class="error-message">Произошла ошибка.</div>
      <button class="error-ok-button">OK</button>
    </div>
  </div>

  <div id="lab-selection-modal" class="modal-overlay is-hidden">
    <div class="modal-content instruction-container" style="max-width: 900px !important; text-align:center;">
      <button class="modal-close-button" title="Закрыть">&times;</button>
      <h2 style="color: #ff8b22 !important; margin-bottom: 5px !important;">Тренажёр: выберите активность</h2>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px; text-align: left;">

        <div>
          <h3 style="margin: 0 0 15px 0; color:#ffcd9c; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; padding-left: 20px;">
            Лабораторные работы
          </h3>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="ThreeBodyProblem-button select-lab-btn" data-lab-id="lab1" style="width:100%; height: 50px; font-size: 15px; border-color: rgba(255, 139, 34, 0.4); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Лаб. №1: Гравитационный манёвр
            </button>
            <button class="ThreeBodyProblem-button select-lab-btn" data-lab-id="lab2" style="width:100%; height: 50px; font-size: 15px; border-color: rgba(255, 139, 34, 0.4); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Лаб. №2: Двойная звезда
            </button>
            <button class="ThreeBodyProblem-button select-lab-btn" data-lab-id="lab3" style="width:100%; height: 50px; font-size: 15px; border-color: rgba(255, 139, 34, 0.4); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Лаб. №3: Побег с орбиты
            </button>
          </div>
        </div>

        <div>
          <h3 style="margin: 0 0 15px 0; color:#7bf0ff; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; padding-left: 20px;">
            Задания (автопроверка)
          </h3>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="ThreeBodyProblem-button select-task-btn" data-task-id="task1"
                    style="width:100%; height: 50px; font-size: 15px; border-color: rgba(123, 240, 255, 0.35); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Задание №1: Побег с орбиты
            </button>

            <button class="ThreeBodyProblem-button select-task-btn" data-task-id="task2"
                    style="width:100%; height: 50px; font-size: 15px; border-color: rgba(123, 240, 255, 0.35); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Задание №2: Удержать орбиту
            </button>

            <button class="ThreeBodyProblem-button select-task-btn" data-task-id="task3"
                    style="width:100%; height: 50px; font-size: 15px; border-color: rgba(123, 240, 255, 0.35); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Задание №3: Точка Лагранжа L4
            </button>

            <button class="ThreeBodyProblem-button select-task-btn" data-task-id="task4"
                    style="width:100%; height: 50px; font-size: 15px; border-color: rgba(123, 240, 255, 0.35); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Задание №4: Побег (сложнее)
            </button>

            <button class="ThreeBodyProblem-button select-task-btn" data-task-id="task5"
                    style="width:100%; height: 50px; font-size: 15px; border-color: rgba(123, 240, 255, 0.35); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Задание №5: Спасти от падения
            </button>

            <button class="ThreeBodyProblem-button select-task-btn" data-task-id="task6"
                    style="width:100%; height: 50px; font-size: 15px; border-color: rgba(123, 240, 255, 0.35); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Задание №6: Дальняя орбита
            </button>

            <button class="ThreeBodyProblem-button select-task-btn" data-task-id="task7"
                    style="width:100%; height: 50px; font-size: 15px; border-color: rgba(123, 240, 255, 0.35); justify-content: flex-start; text-align: left; padding-left: 20px;">
              Задание №7: Точка Лагранжа L5
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="lab-modal" class="modal-overlay is-hidden">
    <div class="modal-content instruction-container" style="border-color: #ff8b22 !important; max-width: 600px !important;">
      <button class="modal-close-button" title="Закрыть">&times;</button>

      <h3 style="color: #ff8b22 !important; margin-top:0 !important; text-transform: uppercase; font-size: 14px;">Тренажёр</h3>
      <h2 id="lab-title" style="margin-bottom: 20px !important; margin-top: 5px !important;">Название</h2>
      
      <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; color: #fff;">Цель:</h4>
        <p id="lab-description" style="margin: 0;">Описание...</p>
      </div>

      <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;">
        <h4 style="margin: 0 0 10px 0; color: #fff;">Инструкция:</h4>
        <ul id="lab-steps" style="margin: 0; padding-left: 20px; color: #eaf0ff;">
          <li>Шаг 1</li>
        </ul>
      </div>

      <div style="text-align: center; margin-top: 25px;">
        <button id="start-lab-button" class="ThreeBodyProblem-button ThreeBodyProblem-button--isSelected"
                style="background: linear-gradient(135deg, #ff8b22 0%, #d85c00 100%); border:none; padding: 0 40px; height: 48px; font-size: 16px;">
          Перейти к настройке
        </button>
      </div>
    </div>
  </div>

  <div id="activity-result-modal" class="modal-overlay is-hidden">
    <div class="modal-content instruction-container" style="max-width: 620px !important; border-color: rgba(123, 240, 255, 0.35) !important;">
      <button class="modal-close-button" title="Закрыть">&times;</button>
      <h3 style="margin-top:0; color:#7bf0ff; text-transform: uppercase; font-size: 13px;">Результат</h3>
      <h2 id="activity-result-title" style="margin: 6px 0 14px 0;">...</h2>

      <div id="activity-result-body" style="background: rgba(0,0,0,0.2); padding: 14px; border-radius: 10px;">
        ...
      </div>

      <div style="display:flex; gap:10px; justify-content:center; margin-top: 18px; flex-wrap:wrap;">
        <button class="ThreeBodyProblem-button" id="activity-result-ok">OK</button>
        <button class="ThreeBodyProblem-button" id="activity-result-download" style="border-color: rgba(123, 240, 255, 0.35);">
          Скачать отчёт (JSON)
        </button>
      </div>
    </div>
  </div>

  <p class="ThreeBodyProblem-debugOutput"></p>

  <script src="script.js"></script>
  <script src="physics.js"></script>
  <script src="graphics.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="simulation.js"></script>

  <script src="labEngine.js"></script>

  <script src="ui.js"></script>

  <script>
    (function() {
      window.chartManager = {};
      const MAX_POINTS = 2000;
      let chartsInited = false;
      let velocityChart = null;
      let accelerationChart = null;
      let frameIndex = 0;

      function trimData(chart) {
        const d = chart.data;
        while (d.labels.length > MAX_POINTS) {
          d.labels.shift();
          chart.data.datasets.forEach(ds => ds.data.shift());
        }
      }

      function resetCharts() {
        if (!chartsInited) return;
        frameIndex = 0;
        velocityChart.data.labels = [];
        velocityChart.data.datasets.forEach(dataset => { dataset.data = []; });
        velocityChart.update('none');
        accelerationChart.data.labels = [];
        accelerationChart.data.datasets.forEach(dataset => { dataset.data = []; });
        accelerationChart.update('none');
      }
      window.chartManager.reset = resetCharts;

      function initCharts() {
        if (chartsInited) return;
        const velCanvas = document.getElementById('velocityChart');
        const accCanvas = document.getElementById('accelerationChart');
        if (!velCanvas || !accCanvas || !window.Chart) return;
        const velCtx = velCanvas.getContext('2d');
        const accCtx = accCanvas.getContext('2d');

        velocityChart = new Chart(velCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'Скорость тела 1', data: [], borderColor: '#ff8b22', pointRadius: 0, tension: 0.1 },
              { label: 'Скорость тела 2', data: [], borderColor: '#6c81ff', pointRadius: 0, tension: 0.1 },
              { label: 'Скорость тела 3', data: [], borderColor: '#4ccd7a', pointRadius: 0, tension: 0.1 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            interaction: { mode: 'nearest', intersect: false },
            plugins: { legend: { display: true }, tooltip: { enabled: true } },
            scales: {
              x: { title: { display: true, text: 'Шаг симуляции' }, ticks: { maxTicksLimit: 8 } },
              y: { title: { display: true, text: 'Скорость (|v|)' }, ticks: { maxTicksLimit: 8 } }
            }
          }
        });

        accelerationChart = new Chart(accCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: [
              { label: 'Ускорение тела 1', data: [], borderColor: '#ff8b22', pointRadius: 0, tension: 0.1 },
              { label: 'Ускорение тела 2', data: [], borderColor: '#6c81ff', pointRadius: 0, tension: 0.1 },
              { label: 'Ускорение тела 3', data: [], borderColor: '#4ccd7a', pointRadius: 0, tension: 0.1 }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false, animation: false,
            interaction: { mode: 'nearest', intersect: false },
            plugins: { legend: { display: true }, tooltip: { enabled: true } },
            scales: {
              x: { title: { display: true, text: 'Шаг симуляции' }, ticks: { maxTicksLimit: 8 } },
              y: { title: { display: true, text: 'Ускорение (|a|)' }, ticks: { maxTicksLimit: 8 } }
            }
          }
        });

        chartsInited = true;

        document.getElementById('vel-details')?.addEventListener('toggle', () => setTimeout(() => velocityChart?.resize(), 0));
        document.getElementById('eng-details')?.addEventListener('toggle', () => setTimeout(() => accelerationChart?.resize(), 0));
        window.addEventListener('resize', () => {
          velocityChart?.resize();
          accelerationChart?.resize();
        });
      }

      function updateCharts() {
        if (window.simulation && typeof simulation.isPaused === 'function' && simulation.isPaused()) {
          requestAnimationFrame(updateCharts);
          return;
        }

        if (window.physics && typeof physics.getSpeeds === 'function' && typeof physics.getAccelerations === 'function') {
          if (!chartsInited) initCharts();
          if (chartsInited) {
            const speeds = physics.getSpeeds();
            const totalSpeed = speeds.reduce((sum, speed) => sum + (speed || 0), 0);

            if (totalSpeed > 0) {
              const accelerations = physics.getAccelerations();
              frameIndex += 1;
              const label = String(frameIndex);

              velocityChart.data.labels.push(label);
              for (let i = 0; i < 3; i++) {
                velocityChart.data.datasets[i].data.push(speeds[i] ?? null);
              }
              trimData(velocityChart);
              velocityChart.update('none');

              accelerationChart.data.labels.push(label);
              for (let i = 0; i < 3; i++) {
                const accMagnitude = accelerations[i] ? Math.sqrt(accelerations[i].ax**2 + accelerations[i].ay**2) : null;
                accelerationChart.data.datasets[i].data.push(accMagnitude);
              }
              trimData(accelerationChart);
              accelerationChart.update('none');
            }
          }
        }
        requestAnimationFrame(updateCharts);
      }

      window.addEventListener('load', () => {
        initCharts();
        requestAnimationFrame(updateCharts);
      });
    })();
  </script>

</body>
</html>